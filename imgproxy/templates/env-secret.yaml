apiVersion: v1
kind: Secret
metadata:
  name: {{ template "imgproxy.fullname" . }}-env-secrets
  labels:
    app: {{ template "imgproxy.fullname" . }}
    chart: "{{ .Chart.Name }}-{{ .Chart.Version }}"
    release: "{{ .Release.Name }}"
    heritage: "{{ .Release.Service }}"
type: kubernetes.io/Opaque
data:
  {{/* https://docs.imgproxy.net/#/configuration?id=url-signature */}}
  {{- with .Values -}}
  {{- if .key -}}
  IMGPROXY_KEY: {{ .key | b64enc | quote }}
  {{- end }}
  {{- if .salt }}
  IMGPROXY_SALT: {{ .salt | b64enc | quote }}
  {{- end }}
  {{- if toString .signatureSize }}
  IMGPROXY_SIGNATURE_SIZE: {{ .signatureSize | quote }}
  {{- end }}
  {{- end -}}

  {{/* https://docs.imgproxy.net/#/configuration?id=server */}}
  {{- with .Values }}
  IMGPROXY_READ_TIMEOUT: {{ .readTimeout | quote }}
  IMGPROXY_WRITE_TIMEOUT: {{ .writeTimeout | quote }}
  IMGPROXY_KEEP_ALIVE_TIMEOUT: {{ .keepAliveTimeout | quote }}
  IMGPROXY_DOWNLOAD_TIMEOUT: {{ .downloadTimeout | quote }}
  IMGPROXY_CONCURRENCY: {{ .concurrency | quote }}
  IMGPROXY_MAX_CLIENTS: {{ .maxClients | quote }}
  IMGPROXY_TTL: {{ .ttl | quote }}
  {{- if .cacheControlPassthrough }}
  IMGPROXY_CACHE_CONTROL_PASSTHROUGH: "true"
  {{- end }}
  {{- if .setCanonicalHeader }}
  IMGPROXY_SET_CANONICAL_HEADER: "true"
  {{- end }}
  {{- if .soReuseport }}
  IMGPROXY_SO_REUSEPORT: "true"
  {{- end }}
  {{- if .pathPrefix }}
  IMGPROXY_PATH_PREFIX: {{ .pathPrefix | quote }}
  {{- end }}
  {{- if .userAgent }}
  IMGPROXY_USER_AGENT: {{ .userAgent | quote }}
  {{- end }}
  {{- if .useEtag }}
  IMGPROXY_USE_ETAG: "true"
  {{- end }}
  {{- if .customRequestHeaders }}
  IMGPROXY_CUSTOM_REQUEST_HEADERS: {{ .customRequestHeaders | quote }}
  {{- end }}
  {{- if .customResponseHeaders }}
  IMGPROXY_CUSTOM_RESPONSE_HEADERS: {{ .customResponseHeaders | quote }}
  {{- end }}
  {{- if .customHeadersSeparator }}
  IMGPROXY_CUSTOM_HEADERS_SEPARATOR: {{ .customHeadersSeparator | quote }}
  {{- end }}
  {{- if .enableDebugHeaders }}
  IMGPROXY_ENABLE_DEBUG_HEADERS: "true"
  {{- end }}
  {{- end -}}

  {{/* https://docs.imgproxy.net/#/configuration?id=security */}}
  {{- with .Values }}
  {{- if .secret }}
  IMGPROXY_SECRET: {{ .secret | b64enc | quote }}
  {{- end }}
  IMGPROXY_MAX_SRC_RESOLUTION: {{ .maxSrcResolution | quote }}
  IMGPROXY_MAX_SRC_FILE_SIZE: {{ .maxSrcFileSize | quote }}
  IMGPROXY_MAX_ANIMATION_FRAMES: {{ .maxAnimationFrames | quote }}
  IMGPROXY_MAX_SVG_CHECK_BYTES: {{ .maxSvgCheckBytes | quote }}
  IMGPROXY_ALLOW_ORIGIN: {{ .allowOrigin | quote }}
  IMGPROXY_ALLOWED_SOURCES: {{ .allowedSources | quote }}
  {{- if .ignoreSslVerification }}
  IMGPROXY_IGNORE_SSL_VERIFICATION: "true"
  {{- end }}
  {{- if .developmentErrorsMode }}
  IMGPROXY_DEVELOPMENT_ERRORS_MODE: "true"
  {{- end }}
  {{- end -}}

  {{/* https://docs.imgproxy.net/#/configuration?id=compression */}}
  {{- with .Values }}
  IMGPROXY_QUALITY: {{ .quality | quote }}
  {{- if .formatQuality }}
  IMGPROXY_FORMAT_QUALITY: {{ .formatQuality | quote }}
  {{- end }}
  IMGPROXY_GZIP_COMPRESSION: {{ .gzipCompression | quote }}
  {{- if .jpegProgressive }}
  IMGPROXY_JPEG_PROGRESSIVE: "true"
  {{- end }}
  {{- if .jpegNoSubsample }}
  IMGPROXY_JPEG_NO_SUBSAMPLE: "true"
  {{- end }}
  {{- if .jpegTrellisQuant }}
  IMGPROXY_JPEG_TRELLIS_QUANT: "true"
  {{- end }}
  {{- if .jpegOvershootDeringing }}
  IMGPROXY_JPEG_OVERSHOOT_DERINGING: "true"
  {{- end }}
  {{- if .jpegOptimizeScans }}
  IMGPROXY_JPEG_OPTIMIZE_SCANS: "true"
  {{- end }}
  IMGPROXY_JPEG_QUANT_TABLE: {{ .jpegQuantTable | quote }}
  {{- if .pngInterlaced }}
  IMGPROXY_PNG_INTERLACED: "true"
  {{- end }}
  {{- if .pngQuantize }}
  IMGPROXY_PNG_QUANTIZE: {{ .pngQuantize | quote }}
  {{- end }}
  IMGPROXY_PNG_QUANTIZATION_COLORS: {{ .pngQuantizationColors | quote }}
  {{- if .gifOptimizeFrames }}
  IMGPROXY_GIF_OPTIMIZE_FRAMES: "true"
  {{- end }}
  {{- if .gifOptimizeTransparency -}}
  IMGPROXY_GIF_OPTIMIZE_TRANSPARENCY: "true"
  {{- end }}
  IMGPROXY_AVIF_SPEED: {{ .avifSpeed | quote }}
  {{- end -}}

  {{/* https://docs.imgproxy.net/#/configuration?id=avifwebp-support-detection */}}
  {{- with .Values }}
  {{- if .enableWebpDetection }}
  IMGPROXY_ENABLE_WEBP_DETECTION: "true"
  {{- end }}
  {{- if .enforceWebp }}
  IMGPROXY_ENFORCE_WEBP: "true"
  {{- end }}
  {{- if .enableAvifDetection }}
  IMGPROXY_ENABLE_WEBP_DETECTION: "true"
  {{- end }}
  {{- if .enforceAvif }}
  IMGPROXY_ENFORCE_WEBP: "true"
  {{- end }}
  {{- end -}}

  {{/* https://docs.imgproxy.net/#/configuration?id=client-hints-support */}}
  {{- with .Values }}
  {{- if .enableClientHints }}
  IMGPROXY_ENABLE_CLIENT_HINTS: "true"
  {{- end }}
  {{- end -}}

  {{/* https://docs.imgproxy.net/#/configuration?id=video-thumbnails */}}
  {{- with .Values }}
  {{- if .enableVideoThumbnails }}
  IMGPROXY_ENABLE_VIDEO_THUMBNAILS: "true"
  {{- end }}
  IMGPROXY_VIDEO_THUMBNAIL_PROBE_SIZE: {{ .videoThumbnailProbeSize | quote }}
  IMGPROXY_VIDEO_THUMBNAIL_MAX_ANALYZE_DURATION: {{ .videoThumbnailMaxAnalyzeDuration | quote }}
  IMGPROXY_VIDEO_THUMBNAIL_SECOND: {{ .videoThumbnailSecond | quote }}
  {{- end -}}

  {{/* https://docs.imgproxy.net/#/configuration?id=watermark */}}
  {{- with .Values }}
  {{- if .watermarkData }}
  IMGPROXY_WATERMARK_DATA: {{ .watermarkData | quote }}
  {{- end }}
  {{- if .watermarkPath }}
  IMGPROXY_WATERMARK_PATH: {{ .watermarkPath | quote }}
  {{- end }}
  {{- if .watermarkUrl }}
  IMGPROXY_WATERMARK_URL: {{ .watermarkUrl | quote }}
  {{- end }}
  IMGPROXY_WATERMARK_OPACITY: {{ .watermarkOpacity | quote }}
  IMGPROXY_WATERMARK_CACHE_SIZE: {{ .watermarkCacheSize | quote }}
  {{- end -}}

  {{/* https://docs.imgproxy.net/#/configuration?id=unsharpening */}}
  {{- with .Values }}
  {{- if .unsharpeningMode }}
  IMGPROXY_USHARPENING_MODE: {{ .unsharpeningMode | quote }}
  {{- end }}
  IMGPROXY_UNSHARPENING_WEIGHT: {{ .unsharpeningWeight | quote }}
  IMGPROXY_UNSHARPENING_DIVIDOR: {{ .unsharpeningDividor | quote }}
  {{- end -}}

  {{/* https://docs.imgproxy.net/#/configuration?id=fallback-image */}}
  {{- with .Values }}
  {{- if .fallbackImageData }}
  IMGPROXY_FALLBACK_IMAGE_DATA: {{ .fallbackImageData | quote }}
  {{- end }}
  {{- if .fallbackImagePath }}
  IMGPROXY_FALLBACK_IMAGE_PATH: {{ .fallbackImagePath | quote }}
  {{- end }}
  {{- if .fallbackImageUrl }}
  IMGPROXY_FALLBACK_IMAGE_URL: {{ .fallbackImageUrl | quote }}
  {{- end }}
  {{- end -}}

  {{/* https://docs.imgproxy.net/#/configuration?id=skip-processing */}}
  {{- with .Values }}
  {{- if .skipProcessingFormats }}
  IMGPROXY_SKIP_PROCESSING_FORMATS: "true"
  {{- end }}
  {{- end -}}

  {{/* https://docs.imgproxy.net/#/configuration?id=presets */}}
  {{- with .Values }}
  {{- if .presets }}
  IMGPROXY_PRESETS: {{ .presets | quote }}
  {{- end }}
  {{- if .onlyPresets }}
  IMGPROXY_ONLY_PRESETS: "true"
  {{- end }}
  {{- end -}}

  {{/* https://docs.imgproxy.net/#/configuration?id=serving-files-from-amazon-s3 */}}
  {{- with .Values }}
  {{- if .useS3 }}
  IMGPROXY_USE_S3: "true"
  {{- if .awsKey }}
  AWS_ACCESS_KEY_ID: {{ .awsKey | b64enc | quote }}
  {{- end }}
  {{- if .awsSecret }}
  AWS_SECRET_ACCESS_KEY: {{ .awsSecret | b64enc | quote }}
  {{- end }}
  {{- if .awsRegion }}
  IMGPROXY_S3_REGION: {{ .awsRegion | quote }}
  {{- end }}
  {{- if .s3Endpoint }}
  IMGPROXY_S3_ENDPOINT: {{ .s3Endpoint | quote }}
  {{- end }}
  {{- end -}}
  {{- end -}}

  {{/* https://docs.imgproxy.net/#/configuration?id=serving-files-from-google-cloud-storage */}}
  {{- with .Values }}
  {{- if .useGcs }}
  IMGPROXY_USE_GCS: "true"
  {{- if .gcsKey }}
  IMGPROXY_GCS_KEY: {{ .gcsKey | b64enc | quote }}
  {{- end }}
  {{- end -}}
  {{- end -}}

  {{/* https://docs.imgproxy.net/#/configuration?id=serving-files-from-azure-blob-storage */}}
  {{- with .Values }}
  {{- if .useAzure }}
  {{- if .azureAccountName }}
  IMGPROXY_ABS_NAME: {{ .azureAccountName | quote }}
  {{- end }}
  {{- if .azureAccountKey }}
  IMGPROXY_ABS_KEY: {{ .azureAccountKey | b64enc | quote }}
  {{- end }}
  {{- if .azureEndpoint }}
  IMGPROXY_ABS_ENDPOINT: {{ .azureEndpoint | quote }}
  {{- end }}
  {{- end -}}
  {{- end -}}

  {{/* https://docs.imgproxy.net/#/configuration?id=new-relic-metrics */}}
  {{- with .Values }}
  {{- if .newRelicKey }}
  IMGPROXY_NEW_RELIC_KEY: {{ .newRelicKey | b64enc | quote }}
  {{- end }}
  {{- if .newRelicAppName }}
  IMGPROXY_NEW_RELIC_APP_NAME: {{ .newRelicAppName | quote }}
  {{- end }}
  {{- end -}}

  {{/* https://docs.imgproxy.net/#/configuration?id=prometheus-metrics */}}
  {{- with .Values }}
  {{- if .enablePrometheus }}
  IMGPROXY_PROMETHEUS_BIND: ":8081"
  {{- end }}
  {{- if .prometheusNamespace }}
  IMGPROXY_PROMETHEUS_NAMESPACE: {{ .prometheusNamespace | quote }}
  {{- end }}
  {{- end -}}

  {{/* https://docs.imgproxy.net/#/configuration?id=error-reporting */}}
  {{- with .Values }}
  {{- if .bugsnagKey }}
  IMGPROXY_BUGSNAG_KEY: {{ .bugsnagKey | b64enc | quote }}
  {{- if .bugsnagStage }}
  IMGPROXY_BUGSNAG_STAGE: {{ .bugsnagStage | quote }}
  {{- end }}
  {{- end -}}
  {{- if .honeybadgerKey }}
  IMGPROXY_HONEYBADGER_KEY: {{ .honeybadgerKey | b64enc | quote }}
  {{- if .honeybadgerEnv }}
  IMGPROXY_HONEYBADGER_ENV: {{ .honeybadgerEnv | quote }}
  {{- end }}
  {{- end -}}
  {{- if .sentryDsn }}
  IMGPROXY_SENTRY_DSN: {{ .sentryDsn | b64enc | quote }}
  {{- if .sentryEnvironment }}
  IMGPROXY_SENTRY_ENVIRONMENT: {{ .sentryEnvironment | quote }}
  {{- end }}
  {{- if .sentryRelease }}
  IMGPROXY_SENTRY_RELEASE: {{ .sentryRelease | quote }}
  {{- end }}
  {{- end -}}
  {{- if .reportDownloadingErrors }}
  IMGPROXY_REPORT_DOWNLOADING_ERRORS: "true"
  {{- end }}
  {{- end -}}

  {{/* https://docs.imgproxy.net/#/configuration?id=log */}}
  {{- with .Values }}
  {{- if .logFormat }}
  IMGPROXY_LOG_FORMAT: {{ .logFormat | quote }}
  {{- end }}
  {{- if .logLevel }}
  IMGPROXY_LOG_LEVEL: {{ .logLevel | quote }}
  {{- end }}
  {{- if .syslogEnable }}
  IMGPROXY_SYSLOG_ENABLE: "true"
  {{- if .syslogLevel }}
  IMGPROXY_SYSLOG_LEVEL: {{ .syslogLevel | quote }}
  {{- end }}
  {{- if .syslogNetwork }}
  IMGPROXY_SYSLOG_NETWORK: {{ .syslogNetwork | quote }}
  {{- end }}
  {{- if .syslogAddress }}
  IMGPROXY_SYSLOG_ADDRESS: {{ .syslogAddress | quote }}
  {{- end }}
  {{- if .syslogTag }}
  IMGPROXY_SYSLOG_TAG: {{ .syslogTag | quote }}
  {{- end }}
  {{- end -}}
  {{- end -}}

  {{/* https://docs.imgproxy.net/#/configuration?id=memory-usage-tweaks */}}
  {{- with .Values }}
  IMGPROXY_DOWNLOAD_BUFFER_SIZE: {{ .downloadBufferSize | quote }}
  IMGPROXY_GZIP_BUFFER_SIZE: {{ .gzipBufferSize | quote }}
  IMGPROXY_FREE_MEMORY_INTERVAL: {{ .freeMemoryInterval | quote }}
  IMGPROXY_BUFFER_POOL_CALIBRATION_THRESHOLD: {{ .bufferPoolCalibrationThreshold | quote }}
  {{- end -}}

  {{/* https://docs.imgproxy.net/#/configuration?id=miscellaneous */}}
  {{- with .Values }}
  {{- if .baseUrl }}
  IMGPROXY_BASE_URL: {{ .baseUrl | quote }}
  {{- end }}
  {{- if .useLinearColorspace }}
  IMGPROXY_USE_LINEAR_COLORSPACE: "true"
  {{- end }}
  {{- if .disableShrinkOnLoad }}
  IMGPROXY_DISABLE_SHRINK_ON_LOAD: "true"
  {{- end }}
  {{- if not .stripMetadata }}
  IMGPROXY_STRIP_METADATA: "false"
  {{- end }}
  {{- if not .stripColorProfile }}
  IMGPROXY_STRIP_COLOR_PROFILE: "false"
  {{- end }}
  {{- if not .autoRotate }}
  IMGPROXY_AUTO_ROTATE: "false"
  {{- end }}
  {{- end -}}
